#!/usr/bin/env nix-shell
#!nix-shell -i bash -p git age git-agecrypt curl

set -e

REPO_LOCATION=$HOME/repositories/tsIgov/hosts-config

BRANCH_NAME=$1
if [ -z $BRANCH_NAME ]; then
	BRANCH_NAME=$(hostname)
fi

SCRIPT_PATH=$(readlink -f $0)
AGE_KEY_LOCATION=~/.age/$BRANCH_NAME

get_private_key
clone_repo
link_configs
install

rm $SCRIPT_PATH

get_private_key() {
	if [ ! -f $AGE_KEY_LOCATION ]; then
		rm -f $AGE_KEY_LOCATION.age
		curl -f -o $AGE_KEY_LOCATION.age https://raw.githubusercontent.com/tsIgov/hosts-config/$BRANCH_NAME/key

		while ! age -d -o $AGE_KEY_LOCATION $AGE_KEY_LOCATION.age
		do
			echo "Try again"
		done

		rm -f $AGE_KEY_LOCATION.age
	fi
}

clone_repo() {
	mkdir -p $REPO_LOCATION
	cd $REPO_LOCATION

	git init
	git branch -m $BRANCH_NAME
	git-agecrypt init
	git-agecrypt config add -i $AGE_KEY_LOCATION
	git remote add origin https://github.com/tsIgov/hosts-config.git
	git pull origin $BRANCH_NAME
}

link_configs() {
	sudo rm -f /etc/nixos
	sudo ln -s $REPO_LOCATION/src /etc/nixos
}

install() {
	sudo nixos-generate-config
	sudo nixos-rebuild switch --flake $(realpath /etc/nixos)#$BRANCH_NAME
}
